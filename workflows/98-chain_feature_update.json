{
  "workflow_metadata": {
    "workflow_id": "98-chain_feature_update",
    "name": "Chain Reflow Feature Update Workflow (Self-Sharpening Auto-Trigger)",
    "version": "1.0.0",
    "description": "Feature update workflow for chain_reflow itself - automatically triggers meta-analysis after feature implementation to ensure continuous self-improvement",
    "created": "2025-11-04",
    "based_on": "reflow/98-reflow_feature_update.json v1.0.0",
    "purpose": "Update chain_reflow's own workflows, tools, or analysis engines, then automatically validate changes through meta-analysis",
    "key_innovation": "Automatically triggers meta-analysis after feature update completes, creating a continuous self-sharpening loop. Optionally runs chain_reflow's specialized tools (matryoshka, causality, creative_linking) on itself.",
    "when_to_use": "When updating chain_reflow's own implementation (workflows/*.json, src/*.py, analysis engines)",
    "do_not_use_for": "Updating OTHER systems - use standard feature_update.json workflow instead",
    "trigger_command": "python3 src/workflow_runner.py workflows/98-chain_feature_update.json"
  },
  "prerequisites": {
    "required_conditions": [
      "Chain Reflow repository exists at /home/ajs7/project/chain_reflow",
      "Reflow repository exists at /home/ajs7/project/reflow (for tools)",
      "Python 3.8+ installed with NetworkX library",
      "Functional architecture exists: specs/functional/functional_architecture.json"
    ],
    "special_note": "This workflow operates on chain_reflow itself (system_root = chain_reflow_root)"
  },
  "entry_points": {
    "standard": {
      "id": "standard",
      "description": "Standard chain_reflow feature update with auto meta-analysis",
      "first_step": "CFU-01"
    }
  },
  "workflow_steps": [
    {
      "step_id": "CFU-01",
      "name": "Setup Chain Reflow Feature Update",
      "description": "Configure working_memory.json for chain_reflow self-update mode",
      "phase": "setup",
      "actions": [
        {
          "action_id": "CFU-01-A01",
          "description": "Update working_memory.json",
          "file": "context/working_memory.json",
          "updates": {
            "current_phase": "chain_reflow_feature_update",
            "system_name": "Chain Reflow System",
            "system_root": "/home/ajs7/project/chain_reflow",
            "operations_since_refresh": 0,
            "chain_reflow_self_update_mode": true,
            "auto_meta_analysis": true
          }
        },
        {
          "action_id": "CFU-01-A02",
          "description": "Record feature being added/updated",
          "purpose": "Track what's being changed for meta-analysis impact assessment",
          "record_in": "context/working_memory.json",
          "field": "chain_reflow_feature_description",
          "examples": [
            "Adding new matryoshka analysis capability",
            "Optimizing creative linking performance",
            "Adding new workflow for multi-framework linking"
          ]
        }
      ],
      "outputs": ["Updated context/working_memory.json"],
      "typical_time": "5 minutes",
      "next_step": "CFU-02"
    },
    {
      "step_id": "CFU-02",
      "name": "Implement Feature",
      "description": "Implement the feature in chain_reflow's code",
      "phase": "feature_implementation",
      "actions": [
        {
          "action_id": "CFU-02-A01",
          "description": "Analyze feature requirements",
          "purpose": "Understand what needs to be implemented",
          "activities": [
            "Define feature scope and acceptance criteria",
            "Identify which files need changes (workflows/*.json, src/*.py, docs/)",
            "Estimate context consumption impact",
            "Identify which functional requirements are affected"
          ]
        },
        {
          "action_id": "CFU-02-A02",
          "description": "Update functional architecture if needed",
          "file": "specs/functional/functional_architecture.json",
          "when": "If feature adds new functions or changes existing flows",
          "updates": [
            "Add new function definitions with context_consumption estimates",
            "Add new function_dependencies (edges)",
            "Update functional_flows if new flows added",
            "Update implements_requirements fields"
          ]
        },
        {
          "action_id": "CFU-02-A03",
          "description": "Implement feature in code",
          "files_to_modify": [
            "workflows/*.json - If adding/updating workflows",
            "src/*.py - If adding/updating analysis engines or tools",
            "specs/ - If adding specifications or schemas",
            "docs/ - If documentation updates needed"
          ],
          "best_practices": [
            "Follow existing code style and patterns",
            "Add docstrings and comments",
            "Consider context consumption in design",
            "Avoid introducing circular dependencies"
          ]
        },
        {
          "action_id": "CFU-02-A04",
          "description": "Test feature implementation",
          "tests": [
            "Manual testing: Run feature and verify outputs",
            "Integration testing: Verify feature works with existing code",
            "Syntax check: python3 -m py_compile src/*.py",
            "JSON validation: Verify workflow JSONs are valid"
          ]
        }
      ],
      "outputs": [
        "Updated chain_reflow implementation files",
        "Updated specs/functional/functional_architecture.json (if applicable)"
      ],
      "typical_time": "2-6 hours depending on feature complexity",
      "gates": [
        {
          "gate_id": "G-CFU-02",
          "name": "Feature Implementation Complete",
          "checks": [
            "Feature code written and syntax-checked",
            "Functional architecture updated if needed",
            "Manual tests pass",
            "Changes ready for meta-analysis validation"
          ],
          "blocking": true
        }
      ],
      "next_step": "CFU-03"
    },
    {
      "step_id": "CFU-03",
      "name": "Auto-Trigger Meta-Analysis: Run Functional Architecture Analysis",
      "description": "Automatically run meta-analysis to validate that the feature update didn't introduce context bottlenecks, gaps, or architectural issues",
      "phase": "meta_analysis",
      "rationale": "CRITICAL: Every chain_reflow feature update must be validated through meta-analysis to ensure self-sharpening discipline",
      "actions": [
        {
          "action_id": "CFU-03-A01",
          "description": "Run functional architecture analysis tool",
          "tool": "analyze_functional_architecture.py",
          "command": "python3 /home/ajs7/project/reflow/tools/analyze_functional_architecture.py /home/ajs7/project/chain_reflow/specs/functional/functional_architecture.json",
          "purpose": "Detect if feature update introduced issues",
          "analyses_performed": [
            "Context path analysis (did feature add context bottlenecks?)",
            "Gap detection (are new functions reachable?)",
            "Cycle detection (did feature introduce unintentional circular dependencies?)",
            "Flow efficiency analysis (is new feature well-integrated?)"
          ]
        },
        {
          "action_id": "CFU-03-A02",
          "description": "Review analysis output",
          "file_output": "specs/functional/functional_architecture_analysis.json",
          "focus_on": [
            "NEW bottleneck paths introduced by feature",
            "NEW unreachable functions introduced by feature",
            "Context consumption delta (before vs after feature)",
            "Any new cycles (may be intentional or problematic)"
          ]
        },
        {
          "action_id": "CFU-03-A03",
          "description": "Categorize issues by severity",
          "severity_levels": {
            "CRITICAL": "Feature introduced context bottlenecks (>160k) or broke existing flows - MUST FIX",
            "WARNING": "Feature approaching limits (>140k) or has inefficiencies - SHOULD FIX",
            "INFO": "Minor optimization opportunities"
          }
        }
      ],
      "outputs": [
        "specs/functional/functional_architecture_analysis.json",
        "Console output with feature impact summary"
      ],
      "typical_time": "5-10 minutes",
      "gates": [
        {
          "gate_id": "G-CFU-03",
          "name": "Analysis Completion",
          "checks": [
            "Analysis completed without errors",
            "functional_architecture_analysis.json generated",
            "All issues categorized by severity"
          ],
          "blocking": true
        }
      ],
      "next_step": "CFU-04"
    },
    {
      "step_id": "CFU-04",
      "name": "Auto-Trigger Meta-Analysis: Refine Functional Architecture (if needed)",
      "description": "If analysis found critical issues with the feature, refine the functional architecture spec",
      "phase": "meta_analysis_refinement",
      "conditional": "Only if CRITICAL or WARNING issues found in CFU-03",
      "actions": [
        {
          "action_id": "CFU-04-A01",
          "description": "Review critical and warning issues introduced by feature",
          "inputs": ["specs/functional/functional_architecture_analysis.json"],
          "focus_on": [
            "Context bottlenecks introduced by new feature",
            "Unreachable functions in new feature",
            "Unintentional cycles created by feature integration"
          ]
        },
        {
          "action_id": "CFU-04-A02",
          "description": "Refine functional architecture to address issues",
          "file": "specs/functional/functional_architecture.json",
          "common_fixes": {
            "context_bottlenecks": "Reduce context_consumption estimates by planning lazy loading or streaming",
            "unreachable_functions": "Add missing function_dependencies to connect new feature",
            "unintentional_cycles": "Redesign function dependencies to break cycle"
          }
        },
        {
          "action_id": "CFU-04-A03",
          "description": "Re-run analysis after refinement",
          "command": "python3 /home/ajs7/project/reflow/tools/analyze_functional_architecture.py /home/ajs7/project/chain_reflow/specs/functional/functional_architecture.json",
          "loop_condition": "If critical issues remain, return to CFU-04-A02",
          "termination": "No critical issues, warnings acceptable"
        }
      ],
      "outputs": ["Refined specs/functional/functional_architecture.json"],
      "typical_time": "30-60 minutes if issues found, 0 minutes if no issues",
      "gates": [
        {
          "gate_id": "G-CFU-04",
          "name": "Critical Issues Resolved in Spec",
          "checks": [
            "No critical architectural issues in functional architecture spec",
            "Warnings documented for implementation fix in CFU-05"
          ],
          "blocking": true
        }
      ],
      "next_step": "CFU-05"
    },
    {
      "step_id": "CFU-05",
      "name": "Auto-Trigger Meta-Analysis: Implementation Refinement (Self-Sharpening)",
      "description": "CRITICAL STEP: Fix actual implementation (workflows, tools) based on analysis results - this is the self-sharpening mechanism",
      "phase": "meta_analysis_implementation_fix",
      "rationale": "Feature may have introduced context bottlenecks or inefficiencies. Fix the actual code to optimize the feature.",
      "actions": [
        {
          "action_id": "CFU-05-A01",
          "description": "Map feature-introduced issues to implementation files",
          "purpose": "Identify which files need to be edited to optimize the new feature",
          "issue_mapping": {
            "context_bottlenecks_in_new_feature": [
              "workflows/*.json - Add context refresh points in new feature workflow steps",
              "src/*.py - Refactor new tool functions to use lazy loading or streaming",
              "src/*.py - Summarize outputs instead of returning full details"
            ],
            "unreachable_functions_in_feature": [
              "workflows/*.json - Add missing workflow steps to create execution path",
              "src/*.py - Add function calls to connect new feature to existing code"
            ],
            "unintentional_cycles_in_feature": [
              "workflows/*.json - Redesign workflow routing to break circular dependency",
              "src/*.py - Add termination conditions to iterative loops"
            ],
            "high_context_functions_in_feature": [
              "src/*.py - Implement lazy loading instead of loading all data at once",
              "src/*.py - Add streaming for large file operations",
              "workflows/*.json - Split high-context steps into smaller steps"
            ]
          },
          "output": "List of files to edit with specific changes needed"
        },
        {
          "action_id": "CFU-05-A02",
          "description": "Fix workflows/*.json files if needed",
          "for_each_issue": "Edit workflow definitions to address architectural issues",
          "examples": [
            "Add context refresh point between high-context steps",
            "Split large workflow into sub-workflows if bottleneck detected",
            "Add missing workflow steps to connect unreachable functions",
            "Add error handling to workflow steps"
          ],
          "validation": "Validate workflow JSON schema after edits"
        },
        {
          "action_id": "CFU-05-A03",
          "description": "Fix src/*.py files if needed",
          "for_each_issue": "Refactor tools to reduce context consumption or improve efficiency",
          "examples": [
            "Lazy loading: Load data on-demand instead of all at once",
            "Streaming: Process large files incrementally",
            "Summarization: Return summaries instead of full details",
            "Error handling: Add try/except blocks with proper error flows",
            "Modularization: Break large functions into smaller helpers"
          ],
          "validation": "python3 -m py_compile src/*.py"
        },
        {
          "action_id": "CFU-05-A04",
          "description": "Test implementation fixes",
          "purpose": "Verify that implementation fixes work correctly and don't introduce regressions",
          "tests": [
            "Dry-run updated workflows to verify executability",
            "Run tools with updated parameters to verify outputs",
            "Integration test: Run feature end-to-end to verify all pieces work",
            "Regression test: Verify existing functionality still works"
          ],
          "success_criteria": [
            "All workflows execute without errors",
            "All tools produce valid outputs",
            "Integration tests pass",
            "No regressions in existing functionality"
          ]
        },
        {
          "action_id": "CFU-05-A05",
          "description": "Update functional_architecture.json to reflect implementation changes",
          "rationale": "Implementation fixes may change context estimates, dependencies, or flows",
          "updates_needed": [
            "Update context_consumption estimates based on refactored code",
            "Add/remove functions if implementation changed",
            "Update function_dependencies if execution flow changed",
            "Update functional_flows if flows were split or merged"
          ],
          "purpose": "Keep functional architecture synchronized with actual implementation"
        },
        {
          "action_id": "CFU-05-A06",
          "description": "Re-run functional architecture analysis",
          "command": "python3 /home/ajs7/project/reflow/tools/analyze_functional_architecture.py /home/ajs7/project/chain_reflow/specs/functional/functional_architecture.json",
          "purpose": "Verify that implementation fixes resolved the architectural issues",
          "expected_results": [
            "Context bottlenecks reduced or eliminated",
            "Unreachable functions now reachable (or removed)",
            "High-context functions optimized (lower context consumption)",
            "Overall max_context_path reduced compared to previous iteration"
          ],
          "loop_condition": "If critical issues remain in implementation, return to CFU-05-A01",
          "termination": "Analysis shows no critical issues, implementation validated"
        }
      ],
      "outputs": [
        "Updated workflows/*.json files (if needed)",
        "Updated src/*.py files (if needed)",
        "Updated specs/functional/functional_architecture.json (reflecting implementation)",
        "Updated specs/functional/functional_architecture_analysis.json (showing resolved issues)",
        "Test results confirming implementation fixes work"
      ],
      "typical_time": "1-2 hours per iteration",
      "iteration_expected": true,
      "max_iterations": 3,
      "gates": [
        {
          "gate_id": "G-CFU-05",
          "name": "Implementation Validated (Self-Sharpening Complete)",
          "checks": [
            "All workflows/*.json files valid and executable",
            "All src/*.py files pass syntax check (python3 -m py_compile)",
            "Integration tests pass",
            "Functional architecture analysis shows critical issues resolved",
            "No regressions introduced",
            "Context consumption reduced for high-context paths (if applicable)",
            "Functional_architecture.json synchronized with actual implementation"
          ],
          "blocking": true,
          "success_message": "Chain_reflow has successfully sharpened itself - feature implemented and optimized"
        }
      ],
      "next_step": "CFU-06"
    },
    {
      "step_id": "CFU-06",
      "name": "Optional: Run Chain_reflow's Specialized Analysis Tools",
      "description": "Optionally run chain_reflow's own specialized tools (matryoshka, causality, creative_linking) on the updated architecture",
      "phase": "optional_enhanced_analysis",
      "optional": true,
      "rationale": "Dogfooding - use chain_reflow's tools on itself to validate they work and provide additional insights",
      "actions": [
        {
          "action_id": "CFU-06-A01",
          "description": "Run matryoshka hierarchical analysis (optional)",
          "tool": "src/matryoshka_analysis.py",
          "command": "python3 /home/ajs7/project/chain_reflow/src/matryoshka_analysis.py --analyze /home/ajs7/project/chain_reflow/specs/functional/functional_architecture.json",
          "purpose": "Check if feature introduced hierarchy level issues",
          "when": "If feature added new functions or changed system structure"
        },
        {
          "action_id": "CFU-06-A02",
          "description": "Review matryoshka results (optional)",
          "output_file": "specs/functional/hierarchy_analysis.json",
          "look_for": [
            "Did feature change hierarchy structure?",
            "Are new functions at correct hierarchy level?",
            "Any new missing intermediate levels?"
          ]
        }
      ],
      "outputs": ["specs/functional/hierarchy_analysis.json (if run)"],
      "typical_time": "10-15 minutes",
      "skip_condition": "Skip if no hierarchy-related changes in feature",
      "next_step": "CFU-07"
    },
    {
      "step_id": "CFU-07",
      "name": "Document Feature and Meta-Analysis Results",
      "description": "Create documentation of feature update and validation results",
      "phase": "documentation",
      "actions": [
        {
          "action_id": "CFU-07-A01",
          "description": "Create feature update report",
          "output_file": "docs/FEATURE_UPDATE_{feature_name}_{date}.md",
          "sections": [
            "Feature Description",
            "Files Changed",
            "Meta-Analysis Results (before/after)",
            "Context Consumption Impact",
            "Issues Found and Fixed",
            "Test Results",
            "Integration Status"
          ]
        },
        {
          "action_id": "CFU-07-A02",
          "description": "Update CHANGELOG.md",
          "file": "CHANGELOG.md",
          "add_entry": {
            "version": "Next release version",
            "date": "Today",
            "changes": [
              "Added: {feature description}",
              "Meta-analysis: {context impact, issues found/fixed}"
            ]
          }
        },
        {
          "action_id": "CFU-07-A03",
          "description": "Update CLAUDE.md if feature changes workflow or architecture",
          "file": "CLAUDE.md",
          "when": "If feature affects how future AI agents should work with chain_reflow",
          "examples": [
            "New workflow added",
            "New analysis capability added",
            "Best practices changed"
          ]
        }
      ],
      "outputs": [
        "docs/FEATURE_UPDATE_{feature_name}_{date}.md",
        "Updated CHANGELOG.md",
        "Updated CLAUDE.md (if needed)"
      ],
      "typical_time": "15-30 minutes",
      "next_step": "CFU-08"
    },
    {
      "step_id": "CFU-08",
      "name": "Commit Changes",
      "description": "Commit all feature and meta-analysis changes to git",
      "phase": "commit",
      "actions": [
        {
          "action_id": "CFU-08-A01",
          "description": "Review all changes",
          "command": "git status && git diff",
          "verify": [
            "Feature implementation files changed",
            "Functional architecture updated (if applicable)",
            "Documentation updated",
            "No unintended changes"
          ]
        },
        {
          "action_id": "CFU-08-A02",
          "description": "Commit changes",
          "commands": [
            "git add .",
            "git commit -m 'feat: {feature_description}\n\nMeta-analysis validated:\n- Max context path: {value}k tokens\n- No critical issues\n- {N} functions, {M} flows\n\nðŸ¤– Generated with Claude Code\nCo-Authored-By: Claude <noreply@anthropic.com>'"
          ],
          "commit_message_template": {
            "format": "conventional_commits",
            "type": "feat | fix | refactor | docs",
            "scope": "Optional (matryoshka | causality | workflows | etc)",
            "description": "Brief feature description",
            "body": [
              "Meta-analysis validated:",
              "- Max context path: Xk tokens",
              "- Critical issues: N",
              "- Warning issues: M",
              "- Functions: N, Flows: M",
              "",
              "ðŸ¤– Generated with Claude Code",
              "Co-Authored-By: Claude <noreply@anthropic.com>"
            ]
          }
        }
      ],
      "outputs": ["Git commit with feature and meta-analysis validation"],
      "typical_time": "5 minutes",
      "next_step": "COMPLETE"
    }
  ],
  "completion_criteria": {
    "required": [
      "Feature implemented in code",
      "Functional architecture updated (if feature added/changed functions)",
      "Meta-analysis run (analyze_functional_architecture.py)",
      "Critical issues resolved (if any found)",
      "Implementation validated (tests pass)",
      "Documentation updated",
      "Changes committed to git"
    ],
    "optional": [
      "Chain_reflow's specialized tools run (matryoshka, causality, etc.)",
      "Feature update report created"
    ]
  },
  "success_criteria": {
    "feature_implementation": "Feature code written, tested, and working",
    "context_health": "No new context bottlenecks introduced (all paths < 160k)",
    "structural_integrity": "No new orphaned or unreachable functions",
    "self_improvement": "If issues found, implementation fixes applied automatically",
    "documentation_complete": "Feature documented in CHANGELOG and reports",
    "committed": "All changes committed to git with meta-analysis results"
  },
  "llm_agent_guidance": {
    "critical_reminders": [
      "This workflow operates on chain_reflow ITSELF - be careful with changes",
      "ALWAYS run meta-analysis after feature implementation (CFU-03)",
      "If critical issues found, MUST fix implementation (CFU-05)",
      "Context consumption is critical metric - track for all new functions",
      "Update functional_architecture.json when adding/changing functions",
      "Test thoroughly before committing"
    ],
    "workflow_philosophy": "Every feature update triggers automatic meta-analysis validation. If issues found, fix implementation immediately. This creates a continuous self-sharpening loop that prevents technical debt accumulation.",
    "dogfooding_note": "Chain_reflow uses its own meta-analysis methodology to improve itself. This validates that the meta-analysis workflows actually work on real systems."
  },
  "comparison_with_standard_feature_update": {
    "standard_feature_update": "Implements feature without meta-analysis validation",
    "98_chain_feature_update": "Implements feature + automatic meta-analysis + automatic fixes",
    "benefit": "Catches issues immediately, prevents technical debt, ensures architectural health",
    "when_to_use_standard": "When updating OTHER systems (not chain_reflow itself)",
    "when_to_use_98": "When updating chain_reflow's own code (workflows, tools, analysis engines)"
  },
  "example_usage": {
    "scenario": "Adding new matryoshka analysis capability",
    "steps": [
      "CFU-01: Setup (5 min)",
      "CFU-02: Implement matryoshka enhancement in src/matryoshka_analysis.py (3 hours)",
      "CFU-03: Run meta-analysis - finds high context consumption (10 min)",
      "CFU-04: Refine functional architecture spec (30 min)",
      "CFU-05: Optimize implementation with lazy loading (1 hour)",
      "CFU-06: Run matryoshka on itself (optional dogfooding) (15 min)",
      "CFU-07: Document feature (20 min)",
      "CFU-08: Commit (5 min)"
    ],
    "total_time": "~5.5 hours (feature would take 3-4 hours without meta-analysis, but might have hidden issues)"
  }
}
